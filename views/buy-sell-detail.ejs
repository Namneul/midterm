<% layout('layout') -%>

<div class="mb-4">
    <h1>
        <% if (post.postType === 'sell') { %>
            <span class="badge bg-danger">팝니다</span>
        <% } else { %>
            <span class="badge bg-primary">삽니다</span>
        <% } %>
        <%= post.title %>
    </h1>

    <p class="text-muted">
        작성자: <%= post.authorNickname %>
        <span class="text-primary fw-bold">(<%= post.authorReputation %>점)</span>
        | 작성일: <%= new Date(post.createdAt).toLocaleString() %>
    </p>

    <h3 class="text-success"><%= post.price.toLocaleString() %> 원</h3>

    <hr>
    <p style="white-space: pre-wrap; min-height: 150px;"><%= post.content %></p>
    <hr>
</div>

<% if (currentUser && currentUser.id === post.authorId) { %>

    <a href="/community/buy-sell/<%= post._id %>/edit" class="btn btn-warning mb-3">
        이 글 수정하기
    </a>

    <form action="/community/buy-sell/<%= post._id %>/delete?_method=DELETE" method="POST"
          onsubmit="return confirm('정말 이 글을 삭제하시겠습니까?');"
          class="mb-3">
        <button type="submit" class="btn btn-danger">이 글 삭제하기</button>
    </form>
<% } %>


<div class="mb-4">
    <h4>댓글 달기</h4>
    <form action="/community/buy-sell/<%= post._id %>/comments" method="POST">
        <div class="input-group">
            <input type="text" class="form-control" name="content" placeholder="댓글을 입력하세요..." required>
            <button class="btn btn-outline-secondary" type="submit">등록</button>
        </div>
    </form>
</div>

<div>
    <h4>댓글 목록 (<%= post.comments.length %>)</h4>
    <ul class="list-group">
        <% if (post.comments.length > 0) { %>
            <% post.comments.forEach(comment => { %>
                <li class="list-group-item">
                    <strong><%= comment.authorNickname %></strong>
                    <small class="text-muted">(<%= new Date(comment.createdAt).toLocaleString() %>)</small>

                    <div class="comment-content-<%= comment._id %>">
                        <p class="mb-0 mt-2"><%= comment.content %></p>
                    </div>

                    <form action="/community/buy-sell/<%= post._id %>/comments/<%= comment._id %>?_method=PUT" method="POST"
                          class="comment-edit-form-<%= comment._id %>" style="display: none;">
                        <div class="input-group mt-2">
                            <input type="text" class="form-control" name="content"
                                   value="<%= comment.content %>" required>
                            <button type="submit" class="btn btn-sm btn-success">저장</button>
                            <button type="button" class="btn btn-sm btn-secondary"
                                    onclick="toggleCommentEdit('<%= comment._id %>', false)">취소</button>
                        </div>
                    </form>

                    <% if (currentUser && currentUser.id === comment.authorId) { %>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-warning"
                                    onclick="toggleCommentEdit('<%= comment._id %>', true)">
                                수정
                            </button>

                            <form action="/community/buy-sell/<%= post._id %>/comments/<%= comment._id %>/delete?_method=DELETE"
                                  method="POST" class="d-inline float-end">
                                <button type="submit" class="btn btn-sm btn-outline-danger">x</button>
                            </form>
                        </div>
                    <% } %>

                </li>
            <% }) %>
        <% } else { %>
            <li class="list-group-item">작성된 댓글이 없습니다.</li>
        <% } %>
    </ul>
</div>

<script>
    function toggleCommentEdit(commentId, showEditForm) {
        const contentDiv = document.querySelector('.comment-content-' + commentId);
        const editForm = document.querySelector('.comment-edit-form-' + commentId);

        if (showEditForm) {
            contentDiv.style.display = 'none';
            editForm.style.display = 'block';
        } else {
            contentDiv.style.display = 'block';
            editForm.style.display = 'none';
        }
    }
</script>