<% layout('layout') -%>

<div class="container mt-4">
    <h1><%= item.title %></h1>

    <div class="row">
        <div class="col-md-6">
            <p>
                <strong>판매자:</strong>
                <%= item.sellerNickname %>
                <span class="text-primary fw-bold">(<%= sellerReputation %> 점)</span>
            </p>
            <div class="col-md-6">
                <div class="card p-3">
                    <p id="highest-bidder" class="text-center text-muted">
                        <% if (item.highestBidderNickname){ %>
                            최고 입찰자: <%= item.highestBidderNickname %>
                            <span class="text-primary fw-bold">(<%= highestBidderReputation %>점)</span>
                        <%= } else { %>
                            (입찰자 없음)
                        <%= }%>
                    </p>
                </div>
            </div>
            <p><strong>마감 시간:</strong> <%= new Date(item.endDate).toLocaleString() %></p>

            <p class="mt-3">
                <strong>첨부 파일:</strong>

                <% if (currentUser && currentUser.id === item.sellerId) { %>
                    <a href="/community/auction/<%= item._id %>/file" target="_blank">
                        [ 내 파일 보기 (<%= item.fileType %>) ]
                    </a>
                <% } else { %>
                    <span style="color: #6c757d;">
                        [ <%= item.fileType %> 파일 (판매자만 접근 가능) ]
                    </span>
                <% } %>
            </p>

            <hr>
            <h4>자료 설명</h4>
            <p style="white-space: pre-wrap;"><%= item.description %></p>
        </div>

        <div class="col-md-6">
            <div class="card p-3">
                <h3 class="text-center">현재 입찰가</h3>
                <h1 id="current-price" class="text-center text-success"><%= item.currentPrice.toLocaleString() %> 원</h1>

                <hr>

                <% if (canBid) { %>
                    <form action="/community/auction/<%= item._id %>/bid" method="POST">
                        <div class="mb-3">
                            <label for="bidPrice" class="form-label">입찰 금액</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="bidPrice" name="bidPrice"
                                       placeholder="현재가보다 높은 금액"
                                       min="<%= item.currentPrice + 1 %>" required>
                                <button class="btn btn-danger" type="submit">즉시 입찰하기</button>
                            </div>
                        </div>
                    </form>
                    <small>마감 1분 전 입찰 시 마감 시간이 1분 연장됩니다.</small>

                <% } else if (currentUser && currentUser.id === item.sellerId) { %>
                    <p class="text-center text-muted">본인이 등록한 경매입니다.</p>

                <% } else if (!currentUser) { %>
                    <p class="text-center">
                        <a href="/auth/login?redirect=/community/auction/<%= item._id %>">로그인</a> 후 입찰할 수 있습니다.
                    </p>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    // 1. 소켓 서버에 연결
    const socket = io();

    // 2. 현재 경매 아이템의 고유 ID (EJS 변수 사용)
    const currentAuctionId = "<%= item._id %>";

    // 3. 서버에 'join:room' 이벤트를 보내 이 방에 입장
    socket.emit('join:room', currentAuctionId);

    // 4. 서버로부터 'bid:update' 이벤트를 수신 대기
    socket.on('bid:update', (data) => {

        // 5. DOM 요소 찾기
        const priceEl = document.getElementById('current-price');
        const bidderEl = document.getElementById('highest-bidder');
        const inputEl = document.getElementById('bidPrice');

        // 6. DOM 내용 실시간 변경
        if (priceEl) {
            priceEl.innerText = data.newPrice.toLocaleString() + ' 원';
        }
        if (bidderEl) {
            bidderEl.innerText = `최고 입찰자: ${data.bidderNickname} <span class ="text-primary fw-bold;">($data.bidderReputation}점)</span>`;
        }
        if (inputEl) {
            // 다음 입찰을 위해 최소 입찰가를 갱신
            inputEl.min = data.newPrice + 1;
            // 혹시 내가 입찰한 금액보다 낮은 금액이 써있으면 지워줌
            if (Number(inputEl.value) <= data.newPrice) {
                inputEl.value = '';
            }
        }
    });
</script>