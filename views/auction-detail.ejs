<%# 1. ë ˆì´ì•„ì›ƒ ì§€ì • %>
<% layout('layout') -%>

<%# 2. ì˜¨ë„ ê³„ì‚° í•¨ìˆ˜ (profile.ejsì™€ ë™ì¼) %>
<%
function calculateTemperatureStyle(score) {
    let temp = 36.5 + (score / 10);
    temp = Math.max(30.0, Math.min(temp, 42.0)).toFixed(1);
    let colorClass = 'text-gray-600 bg-gray-100 border-gray-300'; let emoji = 'ğŸ™‚';
    if (temp >= 40.0) { colorClass = 'text-red-700 bg-red-100 border-red-300'; emoji = 'ğŸ¥µ'; }
    else if (temp >= 38.0) { colorClass = 'text-orange-700 bg-orange-100 border-orange-300'; emoji = 'ğŸ˜Š'; }
    else if (temp >= 36.5) { colorClass = 'text-green-700 bg-green-100 border-green-300'; emoji = 'ğŸ™‚'; }
    else if (temp >= 33.0) { colorClass = 'text-blue-700 bg-blue-100 border-blue-300'; emoji = 'ğŸ˜'; }
    else { colorClass = 'text-blue-900 bg-blue-200 border-blue-400'; emoji = 'ğŸ¥¶'; }
    return { temp, colorClass, emoji };
}
%>

<div class="container mt-4">
    <%# í˜ì´ì§€ ì œëª© %>
    <h1 class="text-2xl font-bold text-gray-800 mb-6"><%= item.title %></h1>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

        <%# 3. ì¢Œì¸¡: ì •ë³´ (â­ï¸ íŒë§¤ì ì˜¨ë„ í‘œì‹œ) %>
        <div class="lg:col-span-5 bg-white shadow rounded-lg border border-gray-200 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">ê²½ë§¤ ì •ë³´</h2>
            <dl class="space-y-3 text-sm">
                <div class="grid grid-cols-3 gap-1">
                    <dt class="font-medium text-gray-500 col-span-1">íŒë§¤ì</dt>
                    <dd class="text-gray-900 col-span-2 flex items-center">
                        <span><%= item.sellerNickname %></span>
                        <%# â­ï¸ í‰íŒ ì ìˆ˜ -> ì˜¨ë„ë¡œ ë³€ê²½ %>
                        <% const sellerTempStyle = calculateTemperatureStyle(sellerReputation); %>
                        <span class="ml-2 px-1.5 py-0.5 rounded-full text-xs font-semibold border <%= sellerTempStyle.colorClass %>">
                           <%= sellerTempStyle.emoji %> <%= sellerTempStyle.temp %>Â°C
                        </span>
                    </dd>
                </div>
                <%# ... (ë§ˆê° ì‹œê°„, íŒŒì¼ ë“± ë‚˜ë¨¸ì§€ ì •ë³´ëŠ” ë™ì¼) ... %>
                <div class="grid grid-cols-3 gap-1"><dt class="font-medium text-gray-500 col-span-1">ë§ˆê° ì‹œê°„</dt><dd class="text-gray-900 col-span-2"><%= new Date(item.endDate).toLocaleString() %><span id="timer" class="font-semibold text-red-600 ml-1"></span></dd></div>
                <div class="grid grid-cols-3 gap-1 items-start"><dt class="font-medium text-gray-500 col-span-1 pt-1">ì²¨ë¶€ íŒŒì¼</dt><dd class="text-gray-900 col-span-2"> <% if (currentUser && currentUser.id === item.sellerId) { %><a href="/community/auction/<%= item._id %>/file" target="_blank" class="text-indigo-600 hover:underline">[ ë‚´ íŒŒì¼ ë³´ê¸° (<%= item.originalFileName || item.fileType %>) ]</a><% } else if (item.status === 'ended' && currentUser && currentUser.id === item.highestBidderId) { %><a href="/community/auction/<%= item._id %>/file" target="_blank" class="font-semibold text-green-600 hover:underline">[ ë‚™ì°° ìë£Œ ë‹¤ìš´ë¡œë“œ ]</a><% } else { %><span class="text-gray-500">[ <%= item.originalFileName || item.fileType %> (ë‚™ì°° ì‹œ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥) ]</span><% } %></dd></div>
            </dl>
            <hr class="my-4">
            <h4 class="text-md font-semibold text-gray-900 mb-2">ìë£Œ ì„¤ëª…</h4>
            <p class="text-sm text-gray-600 leading-relaxed" style="white-space: pre-wrap;"><%= item.description %></p>
        </div>

        <%# 4. ì¤‘ì•™: ì…ì°° (â­ï¸ ìµœê³  ì…ì°°ì ì˜¨ë„ í‘œì‹œ) %>
        <div class="lg:col-span-4 bg-white shadow rounded-lg border border-gray-200 p-6 flex flex-col items-center justify-center">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">í˜„ì¬ ì…ì°°ê°€</h3>
            <p id="current-price" class="text-3xl font-bold text-indigo-600 mb-1"><%= item.currentPrice.toLocaleString() %> ì›</p>
            <%# â­ï¸ í‰íŒ ì ìˆ˜ -> ì˜¨ë„ë¡œ ë³€ê²½ %>
            <p id="highest-bidder" class="text-sm text-gray-500 mb-4 h-5 flex items-center justify-center"> <%# ë†’ì´ ê³ ì • %>
                <% if (item.highestBidderNickname) { %>
                    <span>ìµœê³  ì…ì°°ì: <%= item.highestBidderNickname %></span>
                    <% const bidderTempStyle = calculateTemperatureStyle(highestBidderReputation); %>
                    <span class="ml-1 px-1.5 py-0.5 rounded-full text-xs font-semibold border <%= bidderTempStyle.colorClass %>">
                        <%= bidderTempStyle.emoji %> <%= bidderTempStyle.temp %>Â°C
                     </span>
                <% } else { %>
                    (ì…ì°°ì ì—†ìŒ)
                <% } %>
            </p>
            <hr class="w-full my-4">
            <%# ... (ì…ì°° í¼ / ì¢…ë£Œ ë©”ì‹œì§€ ë¶„ê¸°ëŠ” ë™ì¼) ... %>
            <% if (item.status === 'ended') { %><div class="text-center"><h4 class="text-xl font-bold text-red-600 mb-2">ê²½ë§¤ ì¢…ë£Œë¨</h4> <% if (item.highestBidderNickname) { %><p class="text-gray-700">ìµœì¢… ë‚™ì°°ì: <strong class="font-medium"><%= item.highestBidderNickname %></strong></p> <% if (currentUser && currentUser.id === item.highestBidderId) { %><a href="/community/auction/<%= item._id %>/file" class="mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">ìë£Œ ë‹¤ìš´ë¡œë“œ</a><% } %><% } else { %><p class="text-gray-500">ì…ì°°ì ì—†ì´ ê²½ë§¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p><% } %></div><% } else if (canBid) { %><form action="/community/auction/<%= item._id %>/bid" method="POST" class="w-full space-y-3"><div><label for="bidPrice" class="block text-sm font-medium text-gray-700">ì…ì°° ê¸ˆì•¡</label><div class="mt-1 relative rounded-md shadow-sm"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><span class="text-gray-500 sm:text-sm"> â‚© </span></div><input type="number" name="bidPrice" id="bidPrice" placeholder="í˜„ì¬ê°€ë³´ë‹¤ ë†’ì€ ê¸ˆì•¡" min="<%= item.currentPrice + 1 %>" required class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-7 pr-12 sm:text-sm border-gray-300 rounded-md"></div></div><button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700">ì¦‰ì‹œ ì…ì°°í•˜ê¸°</button></form><small class="block text-center text-xs text-gray-500 mt-2">ë§ˆê° 1ë¶„ ì „ ì…ì°° ì‹œ 1ë¶„ ì—°ì¥ë©ë‹ˆë‹¤.</small><% } else if (currentUser && currentUser.id === item.sellerId) { %><p class="text-center text-gray-500">ë³¸ì¸ì´ ë“±ë¡í•œ ê²½ë§¤ì…ë‹ˆë‹¤.</p><% } else if (!currentUser) { %><p class="text-center text-gray-500"><a href="/auth/login?redirect=/community/auction/<%= item._id %>" class="text-indigo-600 hover:underline font-medium">ë¡œê·¸ì¸</a> í›„ ì…ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><% } %>
        </div>

        <%# 5. ìš°ì¸¡: ì‹¤ì‹œê°„ í˜„í™© (ë³€ê²½ ì—†ìŒ) %>
        <div class="lg:col-span-3 bg-white shadow rounded-lg border border-gray-200 flex flex-col">
            <%# ... (ì ‘ì†ì ìˆ˜, ì±„íŒ…ì°½, ì±„íŒ… í¼ì€ ë™ì¼) ... %>
            <div class="px-4 py-3 border-b border-gray-200"><h3 class="text-md font-semibold text-gray-900">ì‹¤ì‹œê°„ í˜„í™©</h3></div>
            <div class="p-4 text-center text-sm text-gray-600 border-b border-gray-200"><span class="text-green-600 font-bold"><span id="user-count">?</span>ëª…</span>ì´ ì ‘ì† ì¤‘</div>
            <div class="flex-grow flex flex-col"><h5 class="px-4 pt-3 text-sm font-medium text-gray-500">ì±„íŒ…</h5><div class="chat-box flex-grow overflow-y-auto p-4 space-y-3"><ul id="chat-messages" class="space-y-2"></ul></div><% if (currentUser) { %><div class="p-4 border-t border-gray-200"><form id="chat-form" class="flex space-x-2"><input type="text" id="chat-input" placeholder="ë©”ì‹œì§€..." required class="flex-grow shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"><button type="submit" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">ì „ì†¡</button></form></div><% } %></div>
        </div>

    </div> <%# row ë‹«ê¸° %>
</div> <%# container ë‹«ê¸° %>

<%# 6. Socket.IO ìŠ¤í¬ë¦½íŠ¸ (â­ï¸ ìµœê³  ì…ì°°ì ì˜¨ë„ ê°±ì‹ ) %>
<script src="/socket.io/socket.io.js"></script>
<script>
    // ... (ì˜¨ë„ ê³„ì‚° í•¨ìˆ˜ ë³µì‚¬)
    function calculateTemperatureStyle(score) {
        let temp = 36.5 + (score / 10); temp = Math.max(30.0, Math.min(temp, 42.0)).toFixed(1);
        let colorClass = 'text-gray-600 bg-gray-100 border-gray-300'; let emoji = 'ğŸ™‚';
        if (temp >= 40.0) { colorClass = 'text-red-700 bg-red-100 border-red-300'; emoji = 'ğŸ¥µ'; }
        else if (temp >= 38.0) { colorClass = 'text-orange-700 bg-orange-100 border-orange-300'; emoji = 'ğŸ˜Š'; }
        else if (temp >= 36.5) { colorClass = 'text-green-700 bg-green-100 border-green-300'; emoji = 'ğŸ™‚'; }
        else if (temp >= 33.0) { colorClass = 'text-blue-700 bg-blue-100 border-blue-300'; emoji = 'ğŸ˜'; }
        else { colorClass = 'text-blue-900 bg-blue-200 border-blue-400'; emoji = 'ğŸ¥¶'; }
        return { temp, colorClass, emoji };
    }
    // ... (ê¸°ì¡´ ì „ì—­ ë³€ìˆ˜, íƒ€ì´ë¨¸ í•¨ìˆ˜, ì†Œì¼“ ë¦¬ìŠ¤ë„ˆ) ...
    const socket = io(); const currentAuctionId = "<%= item._id %>"; let auctionEndDate = new Date("<%= item.endDate %>"); let timerInterval = null; let auctionEndedFlag = ("<%= item.status %>" === 'ended');
    function startTimer() { /* ... */ }
    socket.emit('join:room', currentAuctionId);
    socket.on('bid:update', (data) => {
        const priceEl = document.getElementById('current-price');
        const bidderEl = document.getElementById('highest-bidder');
        const inputEl = document.getElementById('bidPrice');
        if (priceEl) priceEl.innerText = data.newPrice.toLocaleString() + ' ì›';

        // â­ï¸ [ìˆ˜ì •] ìµœê³  ì…ì°°ì ì˜¨ë„ UI ì—…ë°ì´íŠ¸
        if (bidderEl) {
            const bidderTempStyle = calculateTemperatureStyle(data.bidderReputation); // ì ìˆ˜ë¡œ ìŠ¤íƒ€ì¼ ê³„ì‚°
            bidderEl.innerHTML = `
                <span>ìµœê³  ì…ì°°ì: ${data.bidderNickname}</span>
                <span class="ml-1 px-1.5 py-0.5 rounded-full text-xs font-semibold border ${bidderTempStyle.colorClass}">
                   ${bidderTempStyle.emoji} ${bidderTempStyle.temp}Â°C
                </span>`;
        }
        // ... (input ìµœì†Œê°’, íƒ€ì´ë¨¸ ì¬ì‹œì‘ ë¡œì§ì€ ë™ì¼) ...
        if (inputEl) { inputEl.min = data.newPrice + 1; if (Number(inputEl.value) <= data.newPrice) inputEl.value = ''; } if (data.newEndDate) { auctionEndDate = new Date(data.newEndDate); startTimer(); }
    });
    // ... (room:update, chat:new_message, auction:ended ë¦¬ìŠ¤ë„ˆëŠ” ë™ì¼) ...
    socket.on('room:update', (data) => { const userCountEl = document.getElementById('user-count'); if (userCountEl) userCountEl.innerText = data.count; }); socket.on('chat:new_message', (data) => { /* ... */ }); socket.on('auction:ended', (data) => { /* ... */ });
    // ... (DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: íƒ€ì´ë¨¸ ì‹œì‘, ì±„íŒ… í¼ ë°”ì¸ë”©) ...
    document.addEventListener('DOMContentLoaded', () => { startTimer(); const chatForm = document.getElementById('chat-form'); /* ... */ });
</script>

<style> /* ... (ì¹´ë“œ í˜¸ë²„, ì±„íŒ…ì°½ ë†’ì´ ìŠ¤íƒ€ì¼) ... */ </style>

