<% layout('layout') -%>

<div class="container mt-4">
    <h1><%= item.title %></h1>

    <div class="row">
        <div class="col-md-5">
            <p>
                <strong>íŒë§¤ì:</strong>
                <%= item.sellerNickname %>
                <span class="text-primary fw-bold">(<%= sellerReputation %>ì )</span>
            </p>
            <p>
                <strong>ë§ˆê° ì‹œê°„:</strong>
                <%= new Date(item.endDate).toLocaleString() %>
                <span id="timer" class="fw-bold text-danger ms-2"></span>
            </p>

            <p class="mt-3">
                <strong>ì²¨ë¶€ íŒŒì¼:</strong>
                <% if (currentUser && currentUser.id === item.sellerId) { %>
                    <a href="/community/auction/<%= item._id %>/file" target="_blank">[ ë‚´ íŒŒì¼ ë³´ê¸° (<%= item.originalFileName || item.fileType %>) ]</a>
                <% } else if (item.status === 'ended' && currentUser && currentUser.id === item.highestBidderId) { %>
                    <a href="/community/auction/<%= item._id %>/file" target="_blank" class="text-success fw-bold">[ ë‚™ì°° ìë£Œ ë‹¤ìš´ë¡œë“œ ]</a>
                <% } else { %>
                    <span style="color: #6c757d;">[ <%= item.originalFileName || item.fileType %> (ë‚™ì°° ì‹œ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥) ]</span>
                <% } %>
            </p>

            <hr>
            <h4>ìë£Œ ì„¤ëª…</h4>
            <p style="white-space: pre-wrap;"><%= item.description %></p>
        </div>

        <div class="col-md-4">
            <div class="card p-3">
                <h3 class="text-center">í˜„ì¬ ì…ì°°ê°€</h3>
                <h1 id="current-price" class="text-center text-success"><%= item.currentPrice.toLocaleString() %> ì›</h1>
                <p id="highest-bidder" class="text-center text-muted">
                    <% if (item.highestBidderNickname) { %>
                        ìµœê³  ì…ì°°ì: <%= item.highestBidderNickname %>
                        <span class="text-primary fw-bold">(<%= highestBidderReputation %>ì )</span>
                    <% } else { %>
                        (ì…ì°°ì ì—†ìŒ)
                    <% } %>
                </p>

                <hr>

                <% if (item.status === 'ended') { %>
                    <div class="text-center">
                        <h4 class="text-danger fw-bold">ê²½ë§¤ ì¢…ë£Œë¨</h4>
                        <% if (item.highestBidderNickname) { %>
                            <p><strong>ìµœì¢… ë‚™ì°°ì: <%= item.highestBidderNickname %></strong></p>
                            <% if (currentUser && currentUser.id === item.highestBidderId) { %>
                                <a href="/community/auction/<%= item._id %>/file" class="btn btn-success">ìë£Œ ë‹¤ìš´ë¡œë“œ</a>
                            <% } %>
                        <% } else { %>
                            <p>ì…ì°°ì ì—†ì´ ê²½ë§¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                        <% } %>
                    </div>

                <% } else if (canBid) { %>
                    <form action="/community/auction/<%= item._id %>/bid" method="POST">
                        <div class="mb-3">
                            <label for="bidPrice" class="form-label">ì…ì°° ê¸ˆì•¡</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="bidPrice" name="bidPrice"
                                       placeholder="í˜„ì¬ê°€ë³´ë‹¤ ë†’ì€ ê¸ˆì•¡"
                                       min="<%= item.currentPrice + 1 %>" required>
                                <button class="btn btn-danger" type="submit">ì¦‰ì‹œ ì…ì°°í•˜ê¸°</button>
                            </div>
                        </div>
                    </form>
                    <small>ë§ˆê° 1ë¶„ ì „ ì…ì°° ì‹œ ë§ˆê° ì‹œê°„ì´ 1ë¶„ ì—°ì¥ë©ë‹ˆë‹¤.</small>

                <% } else if (currentUser && currentUser.id === item.sellerId) { %>
                    <p class="text-center text-muted">ë³¸ì¸ì´ ë“±ë¡í•œ ê²½ë§¤ì…ë‹ˆë‹¤.</p>

                <% } else if (!currentUser) { %>
                    <p class="text-center">
                        <a href="/auth/login?redirect=/community/auction/<%= item._id %>">ë¡œê·¸ì¸</a> í›„ ì…ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                <% } %>

            </div> </div> <div class="col-md-3">
            <p class="text-muted text-center border p-2">
                <span class="text-success fw-bold">
                    <span id="user-count">?</span>ëª…
                </span>
                ì´(ê°€) ì ‘ì† ì¤‘
            </p>

            <h5 class="mt-3">ì‹¤ì‹œê°„ ì±„íŒ…</h5>
            <div class="chat-box" style="height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px;">
                <ul id="chat-messages" class="list-unstyled">
                </ul>
            </div>

            <% if (currentUser) { %>
                <form id="chat-form">
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control form-control-sm" placeholder="ë©”ì‹œì§€ ì…ë ¥..." required>
                        <button type="submit" class="btn btn-sm btn-outline-secondary">ì „ì†¡</button>
                    </div>
                </form>
            <% } %>

            </div> </div> </div> </div> <script src="/socket.io/socket.io.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
    // ----------------------------------
    // 1. ì „ì—­ ë³€ìˆ˜ ì„¤ì •
    // ----------------------------------
    const socket = io();
    const currentAuctionId = "<%= item._id %>";

    // â­ï¸ [ì¶”ê°€] 2. íƒ€ì´ë¨¸ë¥¼ ìœ„í•œ ë³€ìˆ˜ (EJSì—ì„œ ë§ˆê° ì‹œê°„ì„ JS ë³€ìˆ˜ë¡œ ë°›ìŒ)
    let auctionEndDate = new Date("<%= item.endDate %>");
    let timerInterval = null; // setIntervalì„ ì €ì¥í•  ë³€ìˆ˜
    let auctionEndedFlag = false; // ì¢…ë£Œ ì´ë²¤íŠ¸ë¥¼ í•œ ë²ˆë§Œ ë³´ë‚´ê¸° ìœ„í•œ í”Œë˜ê·¸

    // ----------------------------------
    // 3. íƒ€ì´ë¨¸ ì‹¤í–‰ í•¨ìˆ˜
    // ----------------------------------
    function startTimer() {
        const timerEl = document.getElementById('timer');
        if (!timerEl) return;

        // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì¤‘ì§€ (ì…ì°° ì—°ì¥ ì‹œ ì¬ì‹œì‘ì„ ìœ„í•´)
        if (timerInterval) clearInterval(timerInterval);

        timerInterval = setInterval(() => {
            const now = new Date();
            const distance = auctionEndDate.getTime() - now.getTime();

            if (distance <= 0) {
                // 3a. íƒ€ì´ë¨¸ ì¢…ë£Œ
                clearInterval(timerInterval);
                timerEl.innerText = "[ê²½ë§¤ ì¢…ë£Œ]";
                if (auctionEndedFlag === false) {
                    auctionEndedFlag = true; // í”Œë˜ê·¸ë¥¼ trueë¡œ ë°”ê¿”ì„œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€

                    // â­ï¸ [ìˆ˜ì •] 2. ì„œë²„ì— "ê²½ë§¤ ì¢…ë£Œ í™•ì¸" ì´ë²¤íŠ¸ ì „ì†¡
                    console.log('íƒ€ì´ë¨¸ 0ì´ˆ. ì„œë²„ì— ì¢…ë£Œ í™•ì¸ ìš”ì²­...');
                    socket.emit('auction:try_end', currentAuctionId);
                }
            } else {
                // 3b. ì‹œê°„ ê³„ì‚° (HH:MM:SS)
                const hours = Math.floor(distance / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                // 3c. íƒ€ì´ë¨¸ í‘œì‹œ (ì˜ˆ: [01:05:30] ë‚¨ìŒ)
                timerEl.innerText = `[${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} ë‚¨ìŒ]`;
            }
        }, 1000);
    }

    // ----------------------------------
    // 4. Socket.IO ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    // ----------------------------------

    // 4a. ì„œë²„ì— ì—°ê²° ë° ë°© ì…ì¥
    socket.emit('join:room', currentAuctionId);

    // 4b. 'bid:update' ìˆ˜ì‹  (ì…ì°° ê°±ì‹ )
    socket.on('bid:update', (data) => {
        // ... (DOM ìš”ì†Œ ì°¾ê¸°: priceEl, bidderEl, inputEl) ...
        const priceEl = document.getElementById('current-price');
        const bidderEl = document.getElementById('highest-bidder');
        const inputEl = document.getElementById('bidPrice');

        // ... (DOM ê°±ì‹ : ê°€ê²©, ë‹‰ë„¤ì„, í‰íŒ, input ìµœì†Œê°’) ...
        if (priceEl) priceEl.innerText = data.newPrice.toLocaleString() + ' ì›';
        if (bidderEl) bidderEl.innerHTML = `ìµœê³  ì…ì°°ì: ${data.bidderNickname} <span class="text-primary fw-bold">(${data.bidderReputation}ì )</span>`;
        if (inputEl) {
            inputEl.min = data.newPrice + 1;
            if (Number(inputEl.value) <= data.newPrice) inputEl.value = '';
        }

        // â­ï¸ [ì¶”ê°€] 4c. 1ë¶„ ì—°ì¥ëœ 'newEndDate' ìˆ˜ì‹ 
        if (data.newEndDate) {
            console.log('1ë¶„ ì—°ì¥! ìƒˆ ë§ˆê° ì‹œê°„:', data.newEndDate);
            auctionEndDate = new Date(data.newEndDate); // íƒ€ì´ë¨¸ì˜ ê¸°ì¤€ ì‹œê°„ ê°±ì‹ 
            startTimer(); // ê°±ì‹ ëœ ì‹œê°„ìœ¼ë¡œ íƒ€ì´ë¨¸ ì¬ì‹œì‘
        }
    });
    socket.on('room:update', (data) => {
        const userCountEl = document.getElementById('user-count');
        if (userCountEl) userCountEl.innerText = data.count;
    });
    socket.on('chat:new_message', (data) => {
        const chatMessages = document.getElementById('chat-messages');
        const chatBox = document.querySelector('.chat-box');
        if (chatMessages) {
            // 1. ìƒˆ <li> íƒœê·¸ ìƒì„±
            const li = document.createElement('li');
            li.innerHTML = `<small><strong>${data.nickname}:</strong> ${data.msg}</small>`;
            // 2. ì±„íŒ…ì°½ì— ì¶”ê°€
            chatMessages.appendChild(li);
            // 3. (UX) ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ë‚´ë¦¼
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    });
    socket.on('auction:ended', (data) => {
        console.log('ì„œë²„ë¡œë¶€í„° ê²½ë§¤ ê³µì‹ ì¢…ë£Œ ì´ë²¤íŠ¸ ìˆ˜ì‹ :', data);

        // 1. í˜„ì¬ ë¡œê·¸ì¸í•œ ë‚´ ID (EJS ë³€ìˆ˜ ì‚¬ìš©)
        const myUserId = "<%= currentUser ? currentUser.id : '' %>";

        if (data.highestBidderId && data.highestBidderId === myUserId) {
            alert('ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ê²½ë§¤ì— ìµœì¢… ë‚™ì°°ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
        }

        // 4. (ëª¨ë“  ìœ ì €) ê²½ë§¤ê°€ ì¢…ë£Œë˜ì—ˆìœ¼ë¯€ë¡œ 2ì´ˆ ë’¤ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨
        setTimeout(() => {
            location.reload();
        }, 2000); // 2ì´ˆ ë’¤ ìƒˆë¡œê³ ì¹¨
    });

    document.addEventListener('DOMContentLoaded', () => {
        // 5a. íƒ€ì´ë¨¸ ì‹œì‘
        if ("<%= item.status %>" === 'active') {
            startTimer();
        } else { /* ... (ì¢…ë£Œ ì²˜ë¦¬) ... */ }

        // â­ï¸ [ì¶”ê°€] 5b. ì±„íŒ… í¼ ì „ì†¡(submit) ì´ë²¤íŠ¸ ë°”ì¸ë”©
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');

        // (ë¡œê·¸ì¸í•œ ìœ ì €ë§Œ chatFormì´ ì¡´ì¬í•¨)
        if (chatForm) {
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault(); // í¼ ê¸°ë³¸ ë™ì‘(ìƒˆë¡œê³ ì¹¨) ë°©ì§€

                const msg = chatInput.value;
                if (msg.trim()) {
                    // (1) ì„œë²„ë¡œ ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
                    socket.emit('chat:send', {
                        msg: msg,
                        // (2) EJS ë³€ìˆ˜ë¡œ í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì €ì˜ ë‹‰ë„¤ì„ ì „ì†¡
                        nickname: "<%= currentUser ? currentUser.anonymousNickname : 'ìµëª…' %>"
                    });

                    // (3) ì…ë ¥ì°½ ë¹„ìš°ê¸°
                    chatInput.value = '';
                }
            });
        }
    });
</script>