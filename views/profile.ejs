<%# 1. 레이아웃 지정 %>
<% layout('layout') -%>

<%# 2. 온도 계산 함수 (EJS 스크립트릿) %>
<%
function calculateTemperatureStyle(score) {
    let temp = 36.5 + (score / 10); // 예: 10점당 1도 상승
    temp = Math.max(30.0, Math.min(temp, 42.0)); // 30도 ~ 42도 제한
    temp = temp.toFixed(1); // 소수점 1자리

    let colorClass = 'text-gray-600 bg-gray-100 border-gray-300'; // 기본 (회색)
    let emoji = '🙂'; // 기본 이모지

    if (temp >= 40.0) { colorClass = 'text-red-700 bg-red-100 border-red-300'; emoji = '🥵'; }
    else if (temp >= 38.0) { colorClass = 'text-orange-700 bg-orange-100 border-orange-300'; emoji = '😊'; }
    else if (temp >= 36.5) { colorClass = 'text-green-700 bg-green-100 border-green-300'; emoji = '🙂'; }
    else if (temp >= 33.0) { colorClass = 'text-blue-700 bg-blue-100 border-blue-300'; emoji = '😐'; }
    else { colorClass = 'text-blue-900 bg-blue-200 border-blue-400'; emoji = '🥶'; } // 매우 낮음 (진한 파랑)

    return { temp, colorClass, emoji };
}
%>

<div class="container mt-4">

    <!-- 3. 프로필 헤더 (⭐️ 온도 표시 적용) -->
    <div class="p-6 mb-8 bg-white rounded-lg shadow border border-gray-200 flex items-start space-x-5">
        <%# 프로필 사진 영역 %>
        <div class="flex-shrink-0">
            <% if (currentUser && currentUser.profileImagePath) { %>
                <% const filename = currentUser.profileImagePath.split('/').pop(); %>
                <img class="h-16 w-16 rounded-full object-cover border-2 border-white shadow-sm" src="/profile/avatar/<%= filename %>" alt="Profile">
            <% } else { %>
                <span class="inline-block h-16 w-16 rounded-full overflow-hidden bg-gray-100 border border-gray-300"><svg class="h-full w-full text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" /></svg></span>
            <% } %>
            <% if (currentUser) { %><a href="/profile/avatar/upload" class="block text-center text-xs text-indigo-600 hover:underline mt-1">사진 변경</a><% } %>
        </div>

        <%# 정보 및 버튼 영역 %>
        <div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2"><%= currentUser.anonymousNickname %> 님의 마이페이지</h1>
            <%# ⭐️ 평판 점수 -> 온도 UI로 변경 %>
            <% const myTempStyle = calculateTemperatureStyle(currentUser.reputationScore); %>
            <div class="mb-3">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-semibold border <%= myTempStyle.colorClass %>">
                    <%= myTempStyle.emoji %>
                    <span class="ml-1"><%= myTempStyle.temp %>°C</span>
                </span>
                <span class="text-xs text-gray-500 ml-1">(매너 온도)</span>
            </div>
            <p class="text-sm text-gray-500 mb-4">(이메일: <%= currentUser.email %>)</p>
            <%# 버튼 영역 %>
            <div class="border-t pt-4 space-x-2">
                <a href="/profile/edit" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">회원정보 수정</a>
                <a href="/profile/password-change" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded shadow-sm text-gray-700 bg-white hover:bg-gray-50">비밀번호 변경</a>
                <%
                let rerollDisabled = false;
                let rerollCooldownText = '';
                const lastChange = currentUser.lastNicknameChange; // 세션에는 이 정보가 없음 -> DB 조회 필요 or 로그인 시 추가
                // 임시: 쿨타임 로직은 라우터에 있으므로 여기선 간단히 버튼만 표시
                // (정확한 쿨타임 표시는 GET /profile 라우터에서 계산해서 넘겨줘야 함)
                %>
                <form action="/profile/reroll-nickname?_method=PUT" method="POST" class="inline">
                    <button type="submit"
                            class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-green-600 hover:bg-green-700 <%= rerollDisabled ? 'opacity-50 cursor-not-allowed' : '' %>"
                            <%= rerollDisabled ? 'disabled' : '' %>
                            title="<%= rerollCooldownText || '7일에 한 번 랜덤 닉네임으로 변경' %>">
                        🎲 닉네임 변경
                    </button>
                </form>
                <button type="button" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-red-600 hover:bg-red-700" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">회원 탈퇴</button>
            </div>
        </div>
    </div>

    <!-- 4. 탭 네비게이션 (변경 없음) -->
    <!-- ... (ul#myProfileTab ...) ... -->
    <div class="mb-4 border-b border-gray-200">
        <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="myProfileTab" role="tablist">
            <li class="mr-2" role="presentation"><button class="inline-block p-4 border-b-2 rounded-t-lg" id="auctions-tab" data-bs-toggle="tab" data-bs-target="#auctions-panel" type="button" role="tab">내 판매 목록 (<%= myAuctions.length %>)</button></li>
            <li class="mr-2" role="presentation"><button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300" id="won-tab" data-bs-toggle="tab" data-bs-target="#won-panel" type="button" role="tab">내 낙찰 목록 (<%= myBidsWon.length %>)</button></li>
            <li class="mr-2" role="presentation"><button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300" id="posts-tab" data-bs-toggle="tab" data-bs-target="#posts-panel" type="button" role="tab">내 작성글 (<%= myPosts.length %>)</button></li>
        </ul>
    </div>

    <!-- 5. 탭 콘텐츠 (변경 없음) -->
    <!-- ... (div#myProfileTabContent ...) ... -->
    <div class="tab-content" id="myProfileTabContent">
        <div class="tab-pane fade" id="auctions-panel" role="tabpanel"> ... (내 판매 목록) ... </div>
        <div class="tab-pane fade" id="won-panel" role="tabpanel"> ... (내 낙찰 목록) ... </div>
        <div class="tab-pane fade" id="posts-panel" role="tabpanel"> ... (내 작성글 목록) ... </div>
    </div>
</div>

<!-- 회원 탈퇴 모달 (변경 없음) -->
<div class="modal fade" id="deleteAccountModal" ...> ... </div>

<!-- Bootstrap 탭 JS (변경 없음) -->
<script> ... </script>